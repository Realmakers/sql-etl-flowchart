# sql-etl-flowchart
# SQL流程图生成器 (SQL to ETL Flowchart Generator) 项目说明文档

## 1. 项目背景

### 1.1 背景与痛点
在数据仓库开发和ETL（Extract, Transform, Load）过程中，工程师经常需要编写和维护长达数百甚至数千行的SQL脚本。这些脚本通常包含复杂的逻辑，如多层嵌套的子查询、公用表表达式（CTE）、临时表创建（Create Table As Select）、以及各种类型的连接（JOIN）和集合操作（UNION）。

直接阅读源码来理解数据流向和处理逻辑存在以下困难：
*   **逻辑晦涩**：嵌套层级过深，难以理清数据来源和去向。
*   **依赖复杂**：难以快速识别表与表之间的依赖关系，尤其是在涉及临时表和多步处理时。
*   **沟通成本高**：在进行代码评审或交接时，纯文本代码难以直观传达业务逻辑。

### 1.2 可行性与必要性
开发一款可视化的SQL流程图生成器具有极高的实用价值：
*   **提高效率**：自动化生成流程图，瞬间理清代码逻辑，减少人工分析时间。
*   **文档化**：生成的流程图可以直接作为技术文档，方便归档和交流。
*   **排错辅助**：通过可视化视图，更容易发现逻辑断层或错误的表引用。
*   **技术可行**：基于现代前端技术栈（React + ReactFlow）和正则解析算法，可以在浏览器端实现轻量级、响应式的解析与渲染，无需复杂的后端支持。

---

## 2. 项目功能

本项目是一个基于Web的工具，旨在将复杂的SQL查询转化为清晰的ETL数据流向图。

### 2.1 核心功能
*   **多模式SQL解析**：
    *   **标准查询**：支持基础的 `SELECT ... FROM ...` 语法。
    *   **CTE支持**：完美解析 `WITH ... AS (...)` 语法，并将其识别为独立的处理节点。
    *   **子查询支持**：识别 `FROM (SELECT ...)` 或 `JOIN (SELECT ...)` 中的子查询，并将其具象化。
    *   **临时表支持**：能够识别 `CREATE TABLE [IF NOT EXISTS] table_name AS SELECT ...` 语法，将其作为带有输入输出的“临时表节点”进行展示。
    *   **集合操作**：支持 `UNION` 和 `UNION ALL` 的依赖关系展示。

*   **智能识别与分类**：
    *   **变量兼容**：支持 `${variable}` 格式的表名或字段名，并能正确关联上下文。
    *   **表类型自动推断**：根据表名规则自动区分“事实表”和“维度表”。
        *   **事实表**：表名包含 `app`, `dm`, `dwd`, `dws` (显示为蓝色标签)。
        *   **维度表**：其他表名 (显示为绿色标签)。

*   **可视化交互**：
    *   **交互式画布**：支持缩放、平移、节点拖拽。
    *   **自动布局**：利用 Dagre 算法自动计算节点位置，减少连线交叉，保证视图整洁。
    *   **丰富的信息展示**：
        *   **字段列表**：展示所有查询字段（支持滚动查看）。
        *   **过滤条件**：完整展示 `WHERE` 和 `HAVING` 条件。
        *   **分组信息**：展示 `GROUP BY` 字段。
    *   **图例说明**：顶部提供清晰的图例（CTE、临时表、事实表、维度表等）。

*   **辅助功能**：
    *   **图片导出**：提供一键下载功能，将当前流程图保存为高清 PNG 图片。
    *   **环境自适应**：内置 Node.js 环境配置脚本，方便在不同机器上快速部署。

---

## 3. 项目构成

项目主要基于 React (Vite) + TypeScript 构建，核心代码位于 `app/frontend/src` 目录下。

### 3.1 目录结构说明

```
app/frontend/src/
├── components/          # UI 组件库
│   ├── nodes/           # 自定义流程图节点
│   │   ├── QueryNode.tsx    # 核心节点组件（展示CTE、子查询、临时表等详细信息）
│   │   └── JoinNode.tsx     # 连接节点组件（展示JOIN类型和条件）
│   ├── ui/              # 基础UI组件 (Button, Card, etc.)
│   ├── FlowChart.tsx    # 流程图画布容器，集成 ReactFlow
│   ├── SqlEditor.tsx    # SQL 代码输入编辑器
│   └── DownloadButton.tsx # 图片下载功能组件
├── lib/                 # 核心逻辑库
│   ├── sqlParser.ts     # 【核心】SQL 解析引擎
│   │   - 负责正则匹配、分词
│   │   - 提取 CTE、临时表、子查询
│   │   - 构建抽象语法树 (AST) 结构的 ParsedSQL 对象
│   └── flowLayoutEngine.ts # 【核心】布局引擎
│       - 将 ParsedSQL 转换为 ReactFlow 的 Nodes 和 Edges
│       - 使用 dagre 进行图形坐标计算
│       - 处理节点间的依赖连接
├── pages/
│   └── Index.tsx        # 主页面，组合 Editor 和 FlowChart
└── App.tsx              # 应用根组件
```

### 3.2 关键模块详解

1.  **解析器 (`sqlParser.ts`)**：
    *   实现了自定义的 SQL 分词和状态机。
    *   `preprocessTempTables`: 预处理提取 `CREATE TABLE AS` 语句。
    *   `extractCTEs`: 提取 `WITH` 语句定义的 CTE。
    *   `processSQL`: 递归处理 SQL 文本，生成包含 tables, fields, joins, filters 的结构化对象。

2.  **布局引擎 (`flowLayoutEngine.ts`)**：
    *   `buildFlowElements`: 接收解析结果，生成图元。
    *   `ensureSourceNode`: 确保物理源表被创建为独立节点。
    *   处理连线逻辑，确保临时表和 CTE 正确连接其上游来源和下游去向。

3.  **查询节点 (`QueryNode.tsx`)**：
    *   高度定制化的 React 组件。
    *   根据节点类型（source, cte, temp, subquery）应用不同颜色主题（蓝、紫、粉、青）。
    *   实现了字段列表的滚动展示和长过滤条件的自动换行。

---

## 4. 使用方法

### 4.1 环境准备
本项目依赖 Node.js (v18+) 环境。如果你本地尚未配置，可以使用项目根目录下的 `setup_env.sh` 脚本进行快速配置（仅限 macOS/Linux）。

**如果你的环境已经安装了 Node.js v18 或更高版本，可以直接跳至 4.2 节。**

#### 使用自动配置脚本
```bash
# 在项目根目录下运行
chmod +x setup_env.sh
./setup_env.sh
```
该脚本会自动下载 Node.js v18.16.0 并配置临时环境变量。

**重要提示**：脚本运行完成后，你需要根据终端提示执行 `export PATH=...` 命令，或者重新开启一个终端窗口，以确保 Node.js 环境生效。

### 4.2 安装依赖
进入前端目录并安装依赖：

```bash
# 进入前端项目目录
cd app/frontend

# 安装依赖 (推荐使用 pnpm，如果未安装 pnpm，setup_env.sh 会自动安装)
pnpm install
# 或者使用 npm install
```

### 4.3 启动项目
启动开发服务器：

```bash
# 确保你在 app/frontend 目录下
pnpm run dev
```

启动成功后，终端会显示访问地址，默认端口为 **3000**。

### 4.4 操作指南
1.  **打开浏览器**：访问 `http://localhost:3000`。
2.  **输入代码**：在左侧的代码编辑框中，粘贴你需要分析的 SQL 脚本。
    *   支持包含 `CREATE TABLE ... AS ...` 的脚本。
    *   支持包含 `WITH ... AS ...` 的脚本。
3.  **生成图表**：点击中间的 **"生成流程图"** 按钮（或相关图标）。右侧画布将自动渲染出数据流向图。
4.  **查看细节**：
    *   **缩放/移动**：使用鼠标滚轮缩放，按住左键拖拽画布。
    *   **查看字段**：在卡片中滚动查看完整的字段列表。
    *   **查看类型**：观察卡片右上角的标签（CTE、临时表等）和顶部的图例。
5.  **导出图片**：点击画布右上角的 **"下载"** 图标，即可将当前流程图保存为 PNG 图片。

### 4.5 常见问题
*   **Q: 为什么我的表被识别为维度表？**
    *   A: 目前系统根据表名自动判断。包含 `app`, `dm`, `dwd`, `dws` 的被视为事实表，其余视为维度表。
*   **Q: `${var}` 变量无法识别？**
    *   A: 最新版本已修复此问题，系统会自动忽略 `${}` 符号进行名称匹配，请放心使用。

